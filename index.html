<!DOCTYPE html>
<meta charset="utf-8">
<style>

/* CSS goes here. */

</style>
<body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>

/* JavaScript goes here. */

var width  = 1500;
var height = 1500;

var vis = d3.select( "body" )
  .append( "svg" )
  .attr( "width", width )
  .attr( "height", height );

queue()
  .defer(d3.json, 'freeways.json')
  .defer(d3.json, 'streets.json')
  .defer(d3.json, 'neighborhoods.json')
  .defer(d3.json, 'arteries.json')
  .await(makeMyMap);

var agency = "sf-muni";

function makeMyMap(error, freeways, streets, neighborhoods, arteries) {
    var center = d3.geo.centroid(freeways)
    var scale  = 150;
    var offset = [width/2, height/2];
    var projection = d3.geo.mercator().scale(scale).center(center)
        .translate(offset);

    // create the path
    var path = d3.geo.path().projection(projection);

    // using the path determine the bounds of the current map and use 
    // these to determine better values for the scale and translation
    var bounds  = path.bounds(freeways);
    var hscale  = scale*width  / (bounds[1][0] - bounds[0][0]);
    var vscale  = scale*height / (bounds[1][1] - bounds[0][1]);
    var scale   = (hscale < vscale) ? hscale : vscale;
    var offset  = [width - (bounds[0][0] + bounds[1][0])/2,
                      height - (bounds[0][1] + bounds[1][1])/2];

    // new projection
    projection = d3.geo.mercator().center(center)
      .scale(scale).translate(offset);
    path = path.projection(projection);

    // add a rectangle to see the bound of the svg
    vis.append("rect").attr('width', width).attr('height', height)
      .style('stroke', 'black').style('fill', 'none');

    vis.selectAll("path").data(streets.features).enter().append("path")
      .attr("d", path)
      .style("stroke-width", "1")
      .style("stroke", "black")
    vis.selectAll("path").data(freeways.features).enter().append("path")
      .attr("d", path)
      .style("stroke-width", "1")
      .style("stroke", "black");
    vis.selectAll("path").data(neighborhoods.features).enter().append("path")
      .attr("d", path)
      .style("stroke-width", "1")
      .style("stroke", "black");
    vis.selectAll("path").data(arteries.features).enter().append("path")
      .attr("d", path)
      .style("stroke-width", "1")
      .style("stroke", "black");
    
    (function animate() {
      var positions = [];
      $.get( "http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&a="+ agency, function( data ) {
        $(data).find("vehicle").each(function() {
          var marker = $(this);
          var point = projection([
            marker.attr("lon"),
            marker.attr("lat")
          ]);
          positions.push({position: point, id: marker.attr("id")});
        });
        console.log(positions.length);
        next(positions);
      });
      setTimeout(animate, 15000);
    }());

    function next(positions) {
		var t = d3.transition()
				.duration(1000);
		// Update circles
		var muni = vis.selectAll("image")
						.data(positions, function(d) { return d.id; });  // Update with new data

  		muni.attr("fill", "red")
			.transition(t)
			.style("fill-opacity", 1e-6)
			.remove();
						
		muni.transition(t)
			.attr("x", function(d) {
		    	return d.position[0];  // Circle's X
			})
			.attr("y", function(d) {
		    	return d.position[1];  // Circle's Y
			});

		muni.enter().append("image")
			.attr("xlink:href", "./muni.png")
			.attr("width", "20")
  	        .attr("height", "20")
			.style("fill-opacity", 1e-6)
			.transition(t)
			.style("fill-opacity", 1)
			.attr("x", function(d) {
		    	return d.position[0];  // Circle's X
			})
			.attr("y", function(d) {
		    	return d.position[1];  // Circle's Y
			});

    }
}



</script>